---
title: 'Effect size: Odds ratio'
author: "Julianna Renzi"
date: "6/5/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load packages
require(tidyverse) # data manipulation and plotting
require(here) # relative paths
```

# Calculate odds ratios

Bring in the data with the subset of studies 

```{r}
or_data <- read_csv(here("data", "Taxa_effectsize.csv")) %>% 
  select(-starts_with("X")) # get rid of extra columns read_csv brings in
```

Apply the HA correction and calculate odds ratios

```{r}
HAcorrection <- 0.5 # Haldaneâ€Anscombe correction (add 0.5 to all cells to avoid dividing by zero)

# calculate the odds ratios (ORs) in gg format
ORgg <- or_data %>% 
  # apply correction for zero data
  mutate(Treat_response = Treat_response + HAcorrection) %>% 
  mutate(Treat_n = Treat_n + HAcorrection) %>% 
  mutate(Control_response = Control_response + HAcorrection) %>% 
  mutate(Control_n = Control_n + HAcorrection) %>% 
  # calculate OR
  mutate(OR = (Treat_response*Control_n)/(Treat_n*Control_response)) %>%
  # calculate log-odds (needed for standard error, CI's etc.)
  mutate(lnOR = log(OR)) %>% 
  mutate(SE = ((1/Treat_response) + (1/Treat_n)
         + (1/Control_response) + (1/Control_n))^0.5) %>%  # this SE is that defined in Ruxton and Neuhauser 2013, pg. 13
  mutate(CI_low = exp(lnOR - (1.96*SE))) %>%  # calculate lower Confidence interval using the Woolf method to find the ones that cross the 1 line with their 95% CIs for plotting
  mutate(Cross1 = ifelse(CI_low > 1, 0, 1)) # zero if the 95% CI does not cross 1
  
```

Plot as a boxplot--to get the PDF version run the code without the hastags/pound signs.

```{r}
# pdf(here("figures/Figure_3.pdf"), width = 6, height = 3.5)

ORgg %>% 
  ggplot(aes(x = Corallivore_family, y = OR)) +
  geom_boxplot(fill = "lightblue", color = "slategray") +
  geom_point(color = "slategray") +
  geom_hline(yintercept = 1, linetype = "dashed") +
  theme_classic() +
  ylab("Odds ratio") +
  xlab("Corallivore family") +
  theme(axis.text.x = element_text(angle = 35, hjust=1))

# dev.off()
```
